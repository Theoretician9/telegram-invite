{% extends "base.html" %}
{% block content %}
<div class="container py-4">
  <h2 class="mb-4">–ê–Ω–∞–ª–∏–∑ –∫–Ω–∏–≥–∏ –∏ –∞–≤—Ç–æ–ø–æ—Å—Ç–∏–Ω–≥</h2>
  <div class="card shadow-lg mb-4">
    <div class="card-body">
      <form id="book-form" enctype="multipart/form-data">
        <div class="mb-3">
          <label for="book" class="form-label">–ó–∞–≥—Ä—É–∑–∏—Ç–µ –∫–Ω–∏–≥—É (txt, pdf)</label>
          <input type="file" class="form-control" id="book" name="book" accept=".txt,.pdf" required>
        </div>
        <button type="submit" class="btn btn-primary">–ó–∞–≥—Ä—É–∑–∏—Ç—å –∫–Ω–∏–≥—É</button>
        <div id="upload-status" class="mt-2" style="display: none;">
          <div class="progress">
            <div class="progress-bar" role="progressbar" style="width: 0%"></div>
          </div>
        </div>
      </form>
      <hr>
      <form id="keys-form" method="post" action="/api/book_analyzer/save_keys">
        <div class="mb-3">
          <label for="gpt_api_key" class="form-label">GPT API Key</label>
          <input type="text" class="form-control" id="gpt_api_key" name="gpt_api_key" required>
        </div>
        <div class="mb-3">
          <label for="together_api_key" class="form-label">Together.ai API Key</label>
          <input type="text" class="form-control" id="together_api_key" name="together_api_key" placeholder="–î–ª—è –º–æ–¥–µ–ª–µ–π Together (–Ω–∞–ø—Ä–∏–º–µ—Ä, DeepSeek)">
        </div>
        <div class="mb-3">
          <label for="gpt_model" class="form-label">–ú–æ–¥–µ–ª—å GPT</label>
          <select class="form-control" id="gpt_model" name="gpt_model" required>
            <option value="gpt-4o">gpt-4o (128k, $0.005/1k —Ç–æ–∫–µ–Ω–æ–≤, –±—ã—Å—Ç—Ä–∞—è, –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–∞—è)</option>
            <option value="gpt-4.1-nano">gpt-4.1-nano (128k, $0.01/1k —Ç–æ–∫–µ–Ω–æ–≤, –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–∞—è)</option>
            <option value="gpt-3.5-turbo-1106">gpt-3.5-turbo-1106 (16k, $0.001/1k —Ç–æ–∫–µ–Ω–æ–≤, –¥—ë—à–µ–≤–æ)</option>
            <option value="deepseek-v3-0324">DeepSeek V3 (Together.ai, 32k, —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è)</option>
            <option value="llama-4-maverick">Llama 4 Maverick 17B 128E Instruct FP8 (Together.ai, 32k, –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞)</option>
            <option value="llama-3.3-70b-turbo">Llama 3.3 70B Instruct Turbo Free (Together.ai, 32k, –±–µ—Å–ø–ª–∞—Ç–Ω–∞—è)</option>
          </select>
        </div>
        <div class="mb-3">
          <label for="telegram_bot_token" class="form-label">Telegram Bot Token</label>
          <input type="text" class="form-control" id="telegram_bot_token" name="telegram_bot_token" required>
        </div>
        <div class="mb-3">
          <label for="chat_id" class="form-label">Chat ID (–∫–∞–Ω–∞–ª –∏–ª–∏ —á–∞—Ç –¥–ª—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏)</label>
          <input type="text" class="form-control" id="chat_id" name="chat_id" required placeholder="@your_channel –∏–ª–∏ -100...">
        </div>
        <div class="mb-3">
          <label for="analysis_prompt" class="form-label">–ü—Ä–æ–º–ø—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞</label>
          <textarea class="form-control" id="analysis_prompt" name="analysis_prompt" rows="4" required>–¢—ã –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–Ω—ã–π —Ä–µ–¥–∞–∫—Ç–æ—Ä. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Ç–µ–∫—Å—Ç –∏ –≤—ã–¥–µ–ª–∏:
1. –û—Å–Ω–æ–≤–Ω—ã–µ —Ç–µ–º—ã –∏ –∏–¥–µ–∏
2. –ö–ª—é—á–µ–≤—ã–µ –º–æ–º–µ–Ω—Ç—ã
3. –í–∞–∂–Ω—ã–µ —Ü–∏—Ç–∞—Ç—ã
4. –ü–µ—Ä—Å–æ–Ω–∞–∂–∏ (–µ—Å–ª–∏ –µ—Å—Ç—å)
5. –°—é–∂–µ—Ç–Ω—ã–µ –ª–∏–Ω–∏–∏ (–µ—Å–ª–∏ –µ—Å—Ç—å)
–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ - JSON.</textarea>
        </div>
        <div class="mb-3">
          <label for="post_prompt" class="form-label">–ü—Ä–æ–º–ø—Ç –¥–ª—è –ø–æ—Å—Ç–æ–≤</label>
          <textarea class="form-control" id="post_prompt" name="post_prompt" rows="8" required>–¢—ã —Å–æ–∑–¥–∞—ë—à—å –ø–æ—Å—Ç—ã –¥–ª—è Telegram-–∫–∞–Ω–∞–ª–∞. –ü—Ä–∞–≤–∏–ª–∞:
1. –î–ª–∏–Ω–∞ –ø–æ—Å—Ç–∞: 200-400 —Å–ª–æ–≤
2. –°—Ç—Ä—É–∫—Ç—É—Ä–∞:
   - –ó–∞—Ö–≤–∞—Ç—ã–≤–∞—é—â–∏–π –∑–∞–≥–æ–ª–æ–≤–æ–∫
   - 2-3 –∞–±–∑–∞—Ü–∞ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
   - –ó–∞–∫–ª—é—á–µ–Ω–∏–µ –∏–ª–∏ –ø—Ä–∏–∑—ã–≤ –∫ –¥–µ–π—Å—Ç–≤–∏—é
3. –°—Ç–∏–ª—å:
   - –ñ–∏–≤–æ–π, —Ä–∞–∑–≥–æ–≤–æ—Ä–Ω—ã–π —è–∑—ã–∫
   - –ö–æ—Ä–æ—Ç–∫–∏–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è
   - –≠–º–æ–¥–∑–∏ –¥–ª—è –≤—ã–¥–µ–ª–µ–Ω–∏—è –∫–ª—é—á–µ–≤—ã—Ö –º–æ–º–µ–Ω—Ç–æ–≤
   - –•–µ—à—Ç–µ–≥–∏ –≤ –∫–æ–Ω—Ü–µ (3-5 —à—Ç—É–∫)
4. –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:
   - –ê–±–∑–∞—Ü—ã —Ä–∞–∑–¥–µ–ª–µ–Ω—ã –ø—É—Å—Ç—ã–º–∏ —Å—Ç—Ä–æ–∫–∞–º–∏
   - –í–∞–∂–Ω—ã–µ –º—ã—Å–ª–∏ –≤—ã–¥–µ–ª–µ–Ω—ã *–∂–∏—Ä–Ω—ã–º*
   - –¶–∏—Ç–∞—Ç—ã –≤ –∫–∞–≤—ã—á–∫–∞—Ö
5. –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ:
   - –ò–Ω—Ç–µ—Ä–µ—Å–Ω—ã–µ —Ñ–∞–∫—Ç—ã –∏–∑ –∫–Ω–∏–≥–∏
   - –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –≤—ã–≤–æ–¥—ã
   - –°–≤—è–∑—å —Å —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–æ—Å—Ç—å—é
   - –õ–∏—á–Ω—ã–π –≤–∑–≥–ª—è–¥ –Ω–∞ –º–∞—Ç–µ—Ä–∏–∞–ª</textarea>
        </div>
        <button type="submit" class="btn btn-secondary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </form>
      <hr>
      <form id="analyze-form" method="post" action="/api/book_analyzer/analyze_book">
        <div class="mb-3">
          <label for="prompt" class="form-label">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞</label>
          <input type="text" class="form-control" id="prompt" name="prompt" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: '–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –∫–Ω–∏–≥—É —Å —Ç–æ—á–∫–∏ –∑—Ä–µ–Ω–∏—è –ø—Å–∏—Ö–æ–ª–æ–≥–∏–∏'">
        </div>
        <button type="submit" class="btn btn-success">–ó–∞–ø—É—Å—Ç–∏—Ç—å –∞–Ω–∞–ª–∏–∑ –∫–Ω–∏–≥–∏</button>
      </form>
      <div id="analyze-status" class="alert alert-info mt-3" style="display:none;"></div>
      <hr>
      <form id="generate-form" method="post" action="/api/book_analyzer/generate_post">
        <button type="submit" class="btn btn-info">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–æ—Å—Ç</button>
      </form>
      <hr>
      <form id="autopost-form" method="post" action="/api/book_analyzer/start_autopost">
        <div class="mb-3">
          <label for="schedule" class="form-label">–í—Ä–µ–º—è –ø—É–±–ª–∏–∫–∞—Ü–∏–π (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é, HH:MM, –ø–æ –ú–æ—Å–∫–≤–µ)</label>
          <input type="text" class="form-control" id="schedule" name="schedule" placeholder="09:00,13:00,18:00">
        </div>
        <button type="submit" class="btn btn-warning">–ó–∞–ø—É—Å—Ç–∏—Ç—å –∞–≤—Ç–æ–ø–æ—Å—Ç–∏–Ω–≥</button>
      </form>
    </div>
  </div>
  <div class="card mt-4">
    <div class="card-header">–ì–ª–∞–≤—ã –∏ –≤—ã–∂–∏–º–∫–∏ –ø–æ—Å–ª–µ –∞–Ω–∞–ª–∏–∑–∞</div>
    <div class="card-body">
      <div id="summaries-list">
        <span class="text-muted">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö. –ü—Ä–æ–≤–µ–¥–∏—Ç–µ –∞–Ω–∞–ª–∏–∑ –∫–Ω–∏–≥–∏.</span>
      </div>
    </div>
  </div>
  <div class="card mt-4">
    <div class="card-header">–õ–æ–≥ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ—Å—Ç–æ–≤</div>
    <div class="card-body">
      <div id="posts-log">
        <!-- –ó–¥–µ—Å—å –±—É–¥–µ—Ç –ª–æ–≥ –ø–æ—Å—Ç–æ–≤ -->
      </div>
    </div>
  </div>
</div>
<script>
document.getElementById('book-form').onsubmit = async function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    const statusDiv = document.getElementById('upload-status');
    const progressBar = statusDiv.querySelector('.progress-bar');
    
    try {
        statusDiv.style.display = 'block';
        progressBar.style.width = '0%';
        
        const resp = await fetch('/api/book_analyzer/upload_book', {
            method: 'POST',
            body: formData
        });
        
        const data = await resp.json();
        if (data.status === 'ok') {
            progressBar.style.width = '100%';
            progressBar.classList.add('bg-success');
            alert('–ö–Ω–∏–≥–∞ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–∞!');
            this.reset();
        } else {
            progressBar.classList.add('bg-danger');
            alert('–û—à–∏–±–∫–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
        }
    } catch (error) {
        console.error('Error:', error);
        progressBar.classList.add('bg-danger');
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–∞: ' + error.message);
    } finally {
        setTimeout(() => {
            statusDiv.style.display = 'none';
            progressBar.classList.remove('bg-success', 'bg-danger');
        }, 3000);
    }
};

document.getElementById('keys-form').onsubmit = async function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    const resp = await fetch('/api/book_analyzer/save_keys', {method: 'POST', body: formData});
    const data = await resp.json();
    alert(data.status === 'ok' ? '–ö–ª—é—á–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!' : data.error);
    if (data.status === 'ok') loadPrompts();
};

document.getElementById('analyze-form').onsubmit = async function(e) {
    e.preventDefault();
    // –û—Ü–µ–Ω–∫–∞ —Å—Ç–æ–∏–º–æ—Å—Ç–∏
    const bookInput = document.getElementById('book');
    let fileSize = 0;
    if (bookInput && bookInput.files && bookInput.files[0]) {
        fileSize = bookInput.files[0].size;
    } else {
        fileSize = 1000000; // –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 1 –ú–ë
    }
    const model = document.getElementById('gpt_model').value;
    let chunkSize = 8000;
    let pricePer1k = 0.01;
    if (model === 'gpt-3.5-turbo-1106') { chunkSize = 40000; pricePer1k = 0.001; }
    if (model === 'gpt-4o') { chunkSize = 320000; pricePer1k = 0.005; }
    if (model === 'gpt-4.1-nano') { chunkSize = 320000; pricePer1k = 0.01; }
    if (model === 'deepseek-v3-0324') { chunkSize = 32000; pricePer1k = 0.0007; } // –ø—Ä–∏–º–µ—Ä–Ω–∞—è —Ü–µ–Ω–∞
    const totalChunks = Math.ceil(fileSize / chunkSize);
    const totalTokens = Math.ceil(fileSize / 4);
    const price = ((totalTokens / 1000) * pricePer1k).toFixed(2);
    if (!confirm(`–ê–Ω–∞–ª–∏–∑ –∫–Ω–∏–≥–∏ –∑–∞–π–º—ë—Ç –ø—Ä–∏–º–µ—Ä–Ω–æ ${totalChunks} –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –º–æ–¥–µ–ª–∏ (${totalTokens} —Ç–æ–∫–µ–Ω–æ–≤).\n–û—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–æ—á–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å: $${price}.\n–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å?`)) {
        return;
    }
    const formData = new FormData(this);
    const resp = await fetch('/api/book_analyzer/analyze_book', {method: 'POST', body: formData});
    const data = await resp.json();
    alert(data.status === 'started' ? '–ê–Ω–∞–ª–∏–∑ –∑–∞–ø—É—â–µ–Ω!' : data.error);
    pollAnalyzeStatus();
};

document.getElementById('generate-form').onsubmit = async function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    const resp = await fetch('/api/book_analyzer/generate_post', {method: 'POST', body: formData});
    const data = await resp.json();
    alert(data.status === 'started' ? '–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–æ—Å—Ç–∞ –∑–∞–ø—É—â–µ–Ω–∞!' : data.error);
};

document.getElementById('autopost-form').onsubmit = async function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    const resp = await fetch('/api/book_analyzer/start_autopost', {method: 'POST', body: formData});
    const data = await resp.json();
    alert(data.status === 'started' ? '–ê–≤—Ç–æ–ø–æ—Å—Ç–∏–Ω–≥ –∑–∞–ø—É—â–µ–Ω!' : data.error);
};

async function updatePostsLog() {
    const resp = await fetch('/api/book_analyzer/posts_log');
    const posts = await resp.json();
    const logDiv = document.getElementById('posts-log');
    logDiv.innerHTML = posts.map(post => `
        <div class="mb-2 p-2 border ${post.published ? 'border-success' : 'border-secondary'}">
            <b>${post.published ? '‚úÖ' : 'üïì'} ${post.created_at}</b><br>
            <span>${post.content.substring(0, 200)}${post.content.length > 200 ? '...' : ''}</span><br>
            <small>–°—Ç–∞—Ç—É—Å: ${post.published ? '–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω' : '–û–∂–∏–¥–∞–µ—Ç'}</small>
            ${!post.published ? `<button class='btn btn-sm btn-primary mt-2' onclick='publishPost(${post.id})'>–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å</button>` : `<button class='btn btn-sm btn-warning mt-2' onclick='publishPost(${post.id}, true)'>–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω–æ</button>`}
        </div>
    `).join('');
}
setInterval(updatePostsLog, 5000);
updatePostsLog();

async function publishPost(postId, force=false) {
    if (!confirm(force ? '–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å —ç—Ç–æ—Ç –ø–æ—Å—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ –≤ Telegram?' : '–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å —ç—Ç–æ—Ç –ø–æ—Å—Ç –≤ Telegram?')) return;
    const resp = await fetch('/api/book_analyzer/publish_post', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ post_id: postId, force: !!force })
    });
    const data = await resp.json();
    alert(data.status === 'ok' ? (force ? '–ü–æ—Å—Ç –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω –ø–æ–≤—Ç–æ—Ä–Ω–æ!' : '–ü–æ—Å—Ç –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω!') : (data.error || '–û—à–∏–±–∫–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏'));
    updatePostsLog();
}

// –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –ø—Ä–æ–º–ø—Ç—ã –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
async function loadPrompts() {
    try {
        const resp = await fetch('/api/book_analyzer/get_prompts');
        const data = await resp.json();
        if (data.status === 'ok') {
            document.getElementById('analysis_prompt').value = data.analysis_prompt;
            document.getElementById('post_prompt').value = data.post_prompt;
            if (data.gpt_model) document.getElementById('gpt_model').value = data.gpt_model;
            if (data.chat_id) document.getElementById('chat_id').value = data.chat_id;
        }
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–ª—é—á–∏ –æ—Ç–¥–µ–ª—å–Ω–æ
        const resp2 = await fetch('/book_analyzer_config.json');
        if (resp2.ok) {
            const config = await resp2.json();
            if (config.gpt_api_key) document.getElementById('gpt_api_key').value = config.gpt_api_key;
            if (config.together_api_key) document.getElementById('together_api_key').value = config.together_api_key;
            if (config.telegram_bot_token) document.getElementById('telegram_bot_token').value = config.telegram_bot_token;
        }
    } catch (error) {
        console.error('Error loading prompts:', error);
    }
}
loadPrompts();

// –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä —Å—Ç–∞—Ç—É—Å–∞ –∞–Ω–∞–ª–∏–∑–∞
async function pollAnalyzeStatus() {
    const statusDiv = document.getElementById('analyze-status');
    try {
        const resp = await fetch('/api/book_analyzer/analyze_status');
        const data = await resp.json();
        if (data.status === 'started' || data.status === 'in_progress') {
            statusDiv.style.display = '';
            statusDiv.className = 'alert alert-info mt-3';
            let progress = data.progress && data.total ? ` (${data.progress}/${data.total})` : '';
            statusDiv.innerHTML = '–ê–Ω–∞–ª–∏–∑ –∫–Ω–∏–≥–∏ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è' + progress + '...';
            setTimeout(pollAnalyzeStatus, 2000);
        } else if (data.status === 'done') {
            statusDiv.style.display = '';
            statusDiv.className = 'alert alert-success mt-3';
            statusDiv.innerHTML = '–ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à—ë–Ω! <a href="' + (data.result_path ? '/download?file=' + encodeURIComponent(data.result_path) : '#') + '" target="_blank">–°–∫–∞—á–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç</a>';
            loadSummaries(); // –æ–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ –≥–ª–∞–≤
        } else if (data.status === 'error') {
            statusDiv.style.display = '';
            statusDiv.className = 'alert alert-danger mt-3';
            statusDiv.innerHTML = '–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞');
        } else {
            statusDiv.style.display = 'none';
        }
    } catch (e) {
        statusDiv.style.display = '';
        statusDiv.className = 'alert alert-danger mt-3';
        statusDiv.innerHTML = '–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –∞–Ω–∞–ª–∏–∑–∞';
    }
}

// –ê–≤—Ç–æ—Å—Ç–∞—Ä—Ç —Å—Ç–∞—Ç—É—Å–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
pollAnalyzeStatus();

async function loadSummaries() {
    const listDiv = document.getElementById('summaries-list');
    listDiv.innerHTML = '<span class="text-muted">–ó–∞–≥—Ä—É–∑–∫–∞...</span>';
    try {
        const resp = await fetch('/api/book_analyzer/summaries');
        const data = await resp.json();
        if (data.status === 'ok' && data.summaries.length) {
            // –î–ª—è –∫–∞–∂–¥–æ–π –≥–ª–∞–≤—ã –ø–æ–¥–≥—Ä—É–∂–∞–µ–º summary
            const items = await Promise.all(data.summaries.map(async s => {
                let summaryText = '';
                try {
                    const resp2 = await fetch('/download?file=' + encodeURIComponent(s.summary_path));
                    if (resp2.ok) {
                        const json = await resp2.json();
                        summaryText = json.summary ? JSON.stringify(json.summary, null, 2) : JSON.stringify(json, null, 2);
                    }
                } catch (e) { summaryText = '[–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ summary]'; }
                return `
                <div class="mb-2 p-2 border ${s.used ? 'border-secondary bg-light' : 'border-success'}">
                  <b>–ì–ª–∞–≤–∞ ${s.chapter}:</b> ${s.title} <br>
                  <span class="badge ${s.used ? 'bg-secondary' : 'bg-success'}">${s.used ? '–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∞' : '–ì–æ—Ç–æ–≤–∞ –∫ –ø–æ—Å—Ç—É'}</span>
                  <pre style="background:#222;color:#bfb;white-space:pre-wrap;max-height:300px;overflow:auto;margin-top:8px;">${summaryText}</pre>
                </div>
                `;
            }));
            listDiv.innerHTML = items.join('');
        } else {
            listDiv.innerHTML = '<span class="text-muted">–ù–µ—Ç –≤—ã–∂–∏–º–æ–∫. –ü—Ä–æ–≤–µ–¥–∏—Ç–µ –∞–Ω–∞–ª–∏–∑ –∫–Ω–∏–≥–∏.</span>';
        }
    } catch (e) {
        listDiv.innerHTML = '<span class="text-danger">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ –≥–ª–∞–≤</span>';
    }
}

// –ó–∞–≥—Ä—É–∂–∞—Ç—å —Å–ø–∏—Å–æ–∫ –≤—ã–∂–∏–º–æ–∫ –ø–æ—Å–ª–µ –∞–Ω–∞–ª–∏–∑–∞ –∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
loadSummaries();
</script>
{% endblock %} 