{% extends "base.html" %}
{% block content %}
<div class="container py-4">
  <h2 class="mb-4">–ê–Ω–∞–ª–∏–∑ –∫–Ω–∏–≥–∏ –∏ –∞–≤—Ç–æ–ø–æ—Å—Ç–∏–Ω–≥</h2>
  <div class="card shadow-lg mb-4">
    <div class="card-body">
      <form id="book-form" enctype="multipart/form-data" method="post" action="/api/book_analyzer/upload_book">
        <div class="mb-3">
          <label for="book" class="form-label">–ó–∞–≥—Ä—É–∑–∏—Ç–µ –∫–Ω–∏–≥—É (txt, docx, pdf)</label>
          <input type="file" class="form-control" id="book" name="book" accept=".txt,.pdf" required>
        </div>
        <button type="submit" class="btn btn-primary">–ó–∞–≥—Ä—É–∑–∏—Ç—å –∫–Ω–∏–≥—É</button>
      </form>
      <hr>
      <form id="keys-form" method="post" action="/api/book_analyzer/save_keys">
        <div class="mb-3">
          <label for="gpt_api_key" class="form-label">GPT API Key</label>
          <input type="text" class="form-control" id="gpt_api_key" name="gpt_api_key" required>
        </div>
        <div class="mb-3">
          <label for="telegram_bot_token" class="form-label">Telegram Bot Token</label>
          <input type="text" class="form-control" id="telegram_bot_token" name="telegram_bot_token" required>
        </div>
        <div class="mb-3">
          <label for="analysis_prompt" class="form-label">–ü—Ä–æ–º–ø—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞</label>
          <textarea class="form-control" id="analysis_prompt" name="analysis_prompt" rows="4" required>–¢—ã –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–Ω—ã–π —Ä–µ–¥–∞–∫—Ç–æ—Ä. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Ç–µ–∫—Å—Ç –∏ –≤—ã–¥–µ–ª–∏:
1. –û—Å–Ω–æ–≤–Ω—ã–µ —Ç–µ–º—ã –∏ –∏–¥–µ–∏
2. –ö–ª—é—á–µ–≤—ã–µ –º–æ–º–µ–Ω—Ç—ã
3. –í–∞–∂–Ω—ã–µ —Ü–∏—Ç–∞—Ç—ã
4. –ü–µ—Ä—Å–æ–Ω–∞–∂–∏ (–µ—Å–ª–∏ –µ—Å—Ç—å)
5. –°—é–∂–µ—Ç–Ω—ã–µ –ª–∏–Ω–∏–∏ (–µ—Å–ª–∏ –µ—Å—Ç—å)
–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ - JSON.</textarea>
        </div>
        <div class="mb-3">
          <label for="post_prompt" class="form-label">–ü—Ä–æ–º–ø—Ç –¥–ª—è –ø–æ—Å—Ç–æ–≤</label>
          <textarea class="form-control" id="post_prompt" name="post_prompt" rows="8" required>–¢—ã —Å–æ–∑–¥–∞—ë—à—å –ø–æ—Å—Ç—ã –¥–ª—è Telegram-–∫–∞–Ω–∞–ª–∞. –ü—Ä–∞–≤–∏–ª–∞:
1. –î–ª–∏–Ω–∞ –ø–æ—Å—Ç–∞: 200-400 —Å–ª–æ–≤
2. –°—Ç—Ä—É–∫—Ç—É—Ä–∞:
   - –ó–∞—Ö–≤–∞—Ç—ã–≤–∞—é—â–∏–π –∑–∞–≥–æ–ª–æ–≤–æ–∫
   - 2-3 –∞–±–∑–∞—Ü–∞ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
   - –ó–∞–∫–ª—é—á–µ–Ω–∏–µ –∏–ª–∏ –ø—Ä–∏–∑—ã–≤ –∫ –¥–µ–π—Å—Ç–≤–∏—é
3. –°—Ç–∏–ª—å:
   - –ñ–∏–≤–æ–π, —Ä–∞–∑–≥–æ–≤–æ—Ä–Ω—ã–π —è–∑—ã–∫
   - –ö–æ—Ä–æ—Ç–∫–∏–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è
   - –≠–º–æ–¥–∑–∏ –¥–ª—è –≤—ã–¥–µ–ª–µ–Ω–∏—è –∫–ª—é—á–µ–≤—ã—Ö –º–æ–º–µ–Ω—Ç–æ–≤
   - –•–µ—à—Ç–µ–≥–∏ –≤ –∫–æ–Ω—Ü–µ (3-5 —à—Ç—É–∫)
4. –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:
   - –ê–±–∑–∞—Ü—ã —Ä–∞–∑–¥–µ–ª–µ–Ω—ã –ø—É—Å—Ç—ã–º–∏ —Å—Ç—Ä–æ–∫–∞–º–∏
   - –í–∞–∂–Ω—ã–µ –º—ã—Å–ª–∏ –≤—ã–¥–µ–ª–µ–Ω—ã *–∂–∏—Ä–Ω—ã–º*
   - –¶–∏—Ç–∞—Ç—ã –≤ –∫–∞–≤—ã—á–∫–∞—Ö
5. –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ:
   - –ò–Ω—Ç–µ—Ä–µ—Å–Ω—ã–µ —Ñ–∞–∫—Ç—ã –∏–∑ –∫–Ω–∏–≥–∏
   - –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –≤—ã–≤–æ–¥—ã
   - –°–≤—è–∑—å —Å —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–æ—Å—Ç—å—é
   - –õ–∏—á–Ω—ã–π –≤–∑–≥–ª—è–¥ –Ω–∞ –º–∞—Ç–µ—Ä–∏–∞–ª</textarea>
        </div>
        <button type="submit" class="btn btn-secondary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </form>
      <hr>
      <form id="analyze-form" method="post" action="/api/book_analyzer/analyze_book">
        <div class="mb-3">
          <label for="prompt" class="form-label">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞</label>
          <input type="text" class="form-control" id="prompt" name="prompt" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: '–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –∫–Ω–∏–≥—É —Å —Ç–æ—á–∫–∏ –∑—Ä–µ–Ω–∏—è –ø—Å–∏—Ö–æ–ª–æ–≥–∏–∏'">
        </div>
        <button type="submit" class="btn btn-success">–ó–∞–ø—É—Å—Ç–∏—Ç—å –∞–Ω–∞–ª–∏–∑ –∫–Ω–∏–≥–∏</button>
      </form>
      <hr>
      <form id="generate-form" method="post" action="/api/book_analyzer/generate_post">
        <button type="submit" class="btn btn-info">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–æ—Å—Ç</button>
      </form>
      <hr>
      <form id="autopost-form" method="post" action="/api/book_analyzer/start_autopost">
        <div class="mb-3">
          <label for="schedule" class="form-label">–í—Ä–µ–º—è –ø—É–±–ª–∏–∫–∞—Ü–∏–π (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é, HH:MM, –ø–æ –ú–æ—Å–∫–≤–µ)</label>
          <input type="text" class="form-control" id="schedule" name="schedule" placeholder="09:00,13:00,18:00">
        </div>
        <button type="submit" class="btn btn-warning">–ó–∞–ø—É—Å—Ç–∏—Ç—å –∞–≤—Ç–æ–ø–æ—Å—Ç–∏–Ω–≥</button>
      </form>
    </div>
  </div>
  <div class="card mt-4">
    <div class="card-header">–õ–æ–≥ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ—Å—Ç–æ–≤</div>
    <div class="card-body">
      <div id="posts-log">
        <!-- –ó–¥–µ—Å—å –±—É–¥–µ—Ç –ª–æ–≥ –ø–æ—Å—Ç–æ–≤ -->
      </div>
    </div>
  </div>
</div>
<script>
document.getElementById('book-form').onsubmit = async function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    const resp = await fetch('/api/book_analyzer/upload_book', {method: 'POST', body: formData});
    const data = await resp.json();
    alert(data.status === 'ok' ? '–ö–Ω–∏–≥–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞!' : data.error);
};

document.getElementById('keys-form').onsubmit = async function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    const resp = await fetch('/api/book_analyzer/save_keys', {method: 'POST', body: formData});
    const data = await resp.json();
    alert(data.status === 'ok' ? '–ö–ª—é—á–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!' : data.error);
};

document.getElementById('analyze-form').onsubmit = async function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    const resp = await fetch('/api/book_analyzer/analyze_book', {method: 'POST', body: formData});
    const data = await resp.json();
    alert(data.status === 'started' ? '–ê–Ω–∞–ª–∏–∑ –∑–∞–ø—É—â–µ–Ω!' : data.error);
};

document.getElementById('generate-form').onsubmit = async function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    const resp = await fetch('/api/book_analyzer/generate_post', {method: 'POST', body: formData});
    const data = await resp.json();
    alert(data.status === 'started' ? '–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–æ—Å—Ç–∞ –∑–∞–ø—É—â–µ–Ω–∞!' : data.error);
};

document.getElementById('autopost-form').onsubmit = async function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    const resp = await fetch('/api/book_analyzer/start_autopost', {method: 'POST', body: formData});
    const data = await resp.json();
    alert(data.status === 'started' ? '–ê–≤—Ç–æ–ø–æ—Å—Ç–∏–Ω–≥ –∑–∞–ø—É—â–µ–Ω!' : data.error);
};

async function updatePostsLog() {
    const resp = await fetch('/api/book_analyzer/posts_log');
    const posts = await resp.json();
    const logDiv = document.getElementById('posts-log');
    logDiv.innerHTML = posts.map(post => `
        <div class="mb-2 p-2 border ${post.published ? 'border-success' : 'border-secondary'}">
            <b>${post.published ? '‚úÖ' : 'üïì'} ${post.created_at}</b><br>
            <span>${post.content.substring(0, 200)}${post.content.length > 200 ? '...' : ''}</span><br>
            <small>–°—Ç–∞—Ç—É—Å: ${post.published ? '–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω' : '–û–∂–∏–¥–∞–µ—Ç'}</small>
        </div>
    `).join('');
}
setInterval(updatePostsLog, 5000);
updatePostsLog();

// –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –ø—Ä–æ–º–ø—Ç—ã –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
async function loadPrompts() {
    try {
        const resp = await fetch('/api/book_analyzer/get_prompts');
        const data = await resp.json();
        if (data.status === 'ok') {
            document.getElementById('analysis_prompt').value = data.analysis_prompt;
            document.getElementById('post_prompt').value = data.post_prompt;
        }
    } catch (error) {
        console.error('Error loading prompts:', error);
    }
}
loadPrompts();
</script>
{% endblock %} 